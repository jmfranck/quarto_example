<style>
  #on-this-page {position:fixed; right:0; top:100px; width:250px; max-height:70vh;
    overflow:auto; background:rgba(248,249,250,0.5); padding:10px;
    border-left:3px solid #0d6efd; font-size:90%;}
  #on-this-page a.active {font-weight:bold; text-decoration:underline;}
</style>
<div id="on-this-page">
  <strong>On this page</strong>
  {% macro render(items) -%}
  <ul>
  {%- for item in items %}
    <li><a href="#{{ item.id }}">{{ item.text }}</a>
    {%- if item.children %}
      {{ render(item.children) }}
    {%- endif %}
    </li>
  {%- endfor %}
  </ul>
  {%- endmacro %}
  {{ render(items) }}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const menu = document.querySelector('#on-this-page');
  const links = menu.querySelectorAll('a');
  const sections = Array.from(links, l => document.getElementById(l.getAttribute('href').slice(1))).filter(Boolean);
  const opts = {rootMargin: '0px 0px -80% 0px'};
  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if(e.isIntersecting){
        links.forEach(l => l.classList.toggle('active', l.getAttribute('href').slice(1) === e.target.id));
      }
    });
  }, opts);
  sections.forEach(s => obs.observe(s));
});
</script>
